import os
import asyncio
import logging
from telegram import (
    Update,
    KeyboardButton,
    ReplyKeyboardMarkup,
    InputMediaPhoto,
    InputMediaVideo,
)
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)
from telegram.error import RetryAfter  # ุงุณุชูุฑุงุฏ ุงูุฎุทุฃ ุงูุฎุงุต ุจุงูููุถุงูุงุช

# ุชุนููู ูุนุฑู ุงูููุงุฉ ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
raw_channel_id = os.getenv("CHANNEL_ID")
if raw_channel_id:
    # ุฅุฐุง ูุงูุช ุงููููุฉ ุชุจุฏุฃ ุจู '@' ูุณุชุฎุฏููุง ููุต
    if raw_channel_id.startswith("@"):
        CHANNEL_ID = raw_channel_id
    else:
        try:
            CHANNEL_ID = int(raw_channel_id)
        except ValueError:
            # ุฅุฐุง ุญุฏุซ ุฎุทุฃ ูู ุงูุชุญูููุ ูุณุชุฎุฏู ุงููููุฉ ููุต
            CHANNEL_ID = raw_channel_id
else:
    CHANNEL_ID = None

# ุฅุนุฏุงุฏ ุงูุชุณุฌูู
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

# ุงูุฑุณุงุฆู ุงููุณุชุฎุฏูุฉ
MESSAGES = {
    "greeting": (
        "Hello {username}! Have you ever found some wonderful images on Telegram, "
        "which you would like to group them together, but don't want to down- and upload them all again? "
        "Let me do that for you real quick.\n\nSend me any photos or videos and I will create Albums out of them!\n\n"
    ),
    "help": (
        'Just forward or send me multiple photos and/or videos. Once you are done, press the "Create Album" Button '
        'and get all your previously sent files jammed together as albums. If you screwed up, click "Clear Album" to start again.\n\n'
        "This piece of shit is made by @wjclub."
    ),
    "settings": "There are no settings to be made here",
    "source": "https://github.com/wjclub/telegram-bot-album-creator",
    "keyboard_done": "Create Album",
    "keyboard_clear": "Reset Album",
    "not_enough_media_items": "Sorry, but you must send me more than two Media elements (Images or Videos) to create an Album.",
    "queue_cleared": "I forgot about all the photos and videos you sent me. You got a new chance.",
    "album_caption": "ุญุตุฑูุงุช๐"
}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    username = update.effective_user.username or "human"
    message = MESSAGES["greeting"].format(username=username)
    keyboard = [
        [KeyboardButton(MESSAGES["keyboard_done"])],
        [KeyboardButton(MESSAGES["keyboard_clear"])]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)
    await update.message.reply_text(message, reply_markup=reply_markup)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text(MESSAGES["help"])

async def settings_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text(MESSAGES["settings"])

async def source_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text(MESSAGES["source"])

async def add_photo(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if "media_queue" not in context.user_data:
        context.user_data["media_queue"] = []
    photo = update.message.photo[-1]
    file_id = photo.file_id
    context.user_data["media_queue"].append({"type": "photo", "media": file_id})
    logger.info("Added photo: %s", file_id)

async def add_video(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if "media_queue" not in context.user_data:
        context.user_data["media_queue"] = []
    video = update.message.video
    file_id = video.file_id
    context.user_data["media_queue"].append({"type": "video", "media": file_id})
    logger.info("Added video: %s", file_id)

async def send_media_group_with_backoff(update: Update, context: ContextTypes.DEFAULT_TYPE, input_media, channel_id, chunk_index):
    """
    ุชุฑุณู ูุฌููุนุฉ ุงููุณุงุฆุท ุฅูู ุงูููุงุฉ ููุท ูุน ุงุณุชุฎุฏุงู ุชูููุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุนูุฏ ุญุฏูุซ ุฎุทุฃ RetryAfter.
    """
    max_retries = 5
    delay = 5  # ุจุฏุงูุฉ ุงูุชุฃุฎูุฑ ุจู 5 ุซูุงูู
    for attempt in range(max_retries):
        try:
            # ุฅุฑุณุงู ุงููุฌููุนุฉ ููุท ุฅูู ุงูููุงุฉ
            await context.bot.send_media_group(chat_id=channel_id, media=input_media)
            return True  # ุชู ุงูุฅุฑุณุงู ุจูุฌุงุญ
        except RetryAfter as e:
            logger.warning("RetryAfter: chunk %d, attempt %d. Waiting for %s seconds.", 
                           chunk_index + 1, attempt + 1, e.retry_after)
            await asyncio.sleep(e.retry_after)
            delay *= 2  # ุฒูุงุฏุฉ ุงูุชุฃุฎูุฑ ุจุดูู ุฃูุณูู
        except Exception as e:
            logger.error("Error sending album chunk %d on attempt %d: %s", 
                         chunk_index + 1, attempt + 1, e)
            print("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุฃูุจูู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ูุงุญูุงู ุฃู ุงูุชูุงุตู ูุนูุง.")
            return False
    return False

async def create_album(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    ุฏุงูุฉ ุฅูุดุงุก ุงูุฃูุจูู ุงูุชู ุชุฌูุน ุงููุณุงุฆุท ุงููุฑุณูุฉ ูุชูุฑุณููุง ูุฃูุจูู ุฅูู ุงูููุงุฉ ููุท.
    """
    media_queue = context.user_data.get("media_queue", [])
    total_media = len(media_queue)

    if total_media < 2:
        print("ููุณ ููุงู ุนุฏุฏ ูุงูู ูู ุงููุณุงุฆุท ูุฅูุดุงุก ุฃูุจูู.")
        return

    logger.info("ุจุฏุก ุชุญููู ุงููุณุงุฆุท ุฅูู ุฃูุจูู. ุฅุฌูุงูู ุงููุณุงุฆุท ุงููุฎุฒูุฉ: %d", total_media)
    
    # ุชูุณูู ุงููุณุงุฆุท ุฅูู ูุฌููุนุงุช ุจุญุฏ ุฃูุตู 10 ุนูุงุตุฑ ููู ูุฌููุนุฉ
    chunks = [media_queue[i: i + 10] for i in range(0, total_media, 10)]
    total_albums = len(chunks)
    processed_albums = 0

    # ุงุณุชุฎุฏุงู ุงููุชุบูุฑ ุงูุนุงููู CHANNEL_ID ูุจุงุดุฑุฉู
    global CHANNEL_ID
    if not CHANNEL_ID:
        print("ูู ูุชู ุชุนููู ูุนุฑู ุงูููุงุฉ ุจุนุฏ. ูุฑุฌู ุชุนููู ุงูููุงุฉ ุฃููุงู.")
        return

    delay_between_albums = 30  # ูุชุฑุฉ ุงูุชุฃุฎูุฑ ุจูู ุฅุฑุณุงู ูู ุฃูุจูู (ุจุงูุซูุงูู)

    for index, chunk in enumerate(chunks):
        input_media = []
        for i, item in enumerate(chunk):
            if i == 0:
                # ุฅุถุงูุฉ ุงูุชุณููุฉ ููุนูุตุฑ ุงูุฃูู ูู ุงููุฌููุนุฉ
                if item["type"] == "photo":
                    input_media.append(
                        InputMediaPhoto(media=item["media"], caption=MESSAGES["album_caption"])
                    )
                elif item["type"] == "video":
                    input_media.append(
                        InputMediaVideo(media=item["media"], caption=MESSAGES["album_caption"])
                    )
            else:
                if item["type"] == "photo":
                    input_media.append(InputMediaPhoto(media=item["media"]))
                elif item["type"] == "video":
                    input_media.append(InputMediaVideo(media=item["media"]))

        # ุฅุฑุณุงู ุงููุฌููุนุฉ ุฅูู ุงูููุงุฉ ููุท ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุนูุฏ ุงูุถุฑูุฑุฉ
        success = await send_media_group_with_backoff(update, context, input_media, CHANNEL_ID, index)
        if not success:
            logger.error("ูุดู ุฅุฑุณุงู ุงูุฌุฒุก %d ูู ุงูุฃูุจูู ุจุนุฏ ุนุฏุฉ ูุญุงููุงุช.", index + 1)

        processed_albums += 1
        remaining_albums = total_albums - processed_albums
        estimated_time_remaining = remaining_albums * delay_between_albums
        minutes, seconds = divmod(estimated_time_remaining, 60)
        time_remaining_str = f"{minutes} ุฏูููุฉ ู {seconds} ุซุงููุฉ"

        progress_message = (
            f"ุงูุชูุฏู: {processed_albums}/{total_albums} ุฃูุจููุงุช ุชู ุฅุฑุณุงููุง.\n"
            f"ุงูููุช ุงููุชุจูู ุงููุชููุน: {time_remaining_str}."
        )
        print(progress_message)
        logger.info(progress_message)

        await asyncio.sleep(delay_between_albums)

    # ุชูุฑูุบ ูุงุฆูุฉ ุงููุณุงุฆุท ุจุนุฏ ุงูุงูุชูุงุก
    context.user_data["media_queue"] = []
    print("ุชู ุฅุฑุณุงู ุฌููุน ุงูุฃูุจููุงุช ุจูุฌุงุญ ุฅูู ุงูููุงุฉ!")

async def create_album(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    # ุฌูุจ ูุงุฆูุฉ ุงููุณุงุฆุท ูู ุจูุงูุงุช ุงููุณุชุฎุฏู
    media_queue = context.user_data.get("media_queue", [])
    total_media = len(media_queue)

    # ุงูุชุฃูุฏ ูู ูุฌูุฏ ุนุฏุฏ ูุงูู ูู ุงููุณุงุฆุท ูุฅูุดุงุก ุฃูุจูู
    if total_media < 2:
        print("Not enough media items to create an album.")
        return

    logger.info("Starting album conversion. Total media stored: %d", total_media)

    # ุชูุณูู ุงููุณุงุฆุท ุฅูู ูุฌููุนุงุช ูุง ุชุฒูุฏ ุนู 10 ุนูุงุตุฑ ููู ูุฌููุนุฉ
    chunks = [media_queue[i: i + 10] for i in range(0, total_media, 10)]
    total_albums = len(chunks)
    processed_albums = 0

    # ุงุณุชุฎุฏุงู ุงููุชุบูุฑ ุงูุนุงููู CHANNEL_ID ูุจุงุดุฑุฉู
    global CHANNEL_ID
    if not CHANNEL_ID:
        print("No channel has been set yet. Use /setchannel in your channel.")
        return

    delay_between_albums = 30  # ูุชุฑุฉ ุงูุชุฃุฎูุฑ ุจูู ุฅุฑุณุงู ูู ุฃูุจูู (ุจุงูุซูุงูู)

    # ุฅุฑุณุงู ูู ูุฌููุนุฉ ูุฃูุจูู
    for index, chunk in enumerate(chunks):
        input_media = []
        for i, item in enumerate(chunk):
            if i == 0:
                # ุฅุถุงูุฉ ุงูุชุณููุฉ ููุนูุตุฑ ุงูุฃูู ูู ุงููุฌููุนุฉ
                if item["type"] == "photo":
                    input_media.append(
                        InputMediaPhoto(media=item["media"], caption=MESSAGES["album_caption"])
                    )
                elif item["type"] == "video":
                    input_media.append(
                        InputMediaVideo(media=item["media"], caption=MESSAGES["album_caption"])
                    )
            else:
                if item["type"] == "photo":
                    input_media.append(InputMediaPhoto(media=item["media"]))
                elif item["type"] == "video":
                    input_media.append(InputMediaVideo(media=item["media"]))

        # ูุญุงููุฉ ุฅุฑุณุงู ูุฌููุนุฉ ุงููุณุงุฆุท ูุน ุงุนุงุฏุฉ ุงููุญุงููุฉ ุนูุฏ ุญุฏูุซ ุฃุฎุทุงุก ุงูููุถุงูุงุช
        success = await send_media_group_with_backoff(update, context, input_media, CHANNEL_ID, index)
        if not success:
            logger.error("Failed to send album chunk %d after retries.", index + 1)

        processed_albums += 1
        remaining_albums = total_albums - processed_albums
        estimated_time_remaining = remaining_albums * delay_between_albums
        minutes, seconds = divmod(estimated_time_remaining, 60)
        time_remaining_str = f"{minutes} minutes and {seconds} seconds"

        progress_message = (
            f"Progress: {processed_albums}/{total_albums} albums sent.\n"
            f"Estimated time remaining: {time_remaining_str}."
        )
        print(progress_message)
        logger.info(progress_message)

        # ุงูุงูุชุธุงุฑ ููุชุฑุฉ ูุญุฏุฏุฉ ูุจู ุฅุฑุณุงู ุงูุฃูุจูู ุงูุชุงูู ูุชูุงุฏู ุชุฌุงูุฒ ุงูุญุฏูุฏ
        await asyncio.sleep(delay_between_albums)

    # ุชูุฑูุบ ูุงุฆูุฉ ุงููุณุงุฆุท ุจุนุฏ ุงูุงูุชูุงุก ูู ุฅุฑุณุงู ุงูุฃูุจููุงุช
    context.user_data["media_queue"] = []
    print("All albums have been sent successfully!")

async def reset_album(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    context.user_data["media_queue"] = []
    await update.message.reply_text(MESSAGES["queue_cleared"])

def main() -> None:
    token = os.getenv("BOT_TOKEN")
    if not token:
        logger.error("BOT_TOKEN not set in environment variables.")
        return
    application = Application.builder().token(token).build()
    # ุชุณุฌูู ุงูุฃูุงูุฑ ุงูุฃุณุงุณูุฉ
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("settings", settings_command))
    application.add_handler(CommandHandler("source", source_command))
    # ุชุณุฌูู ูุนุงูุฌุงุช ุงูุตูุฑ ูุงูููุฏูููุงุช
    application.add_handler(MessageHandler(filters.PHOTO, add_photo))
    application.add_handler(MessageHandler(filters.VIDEO, add_video))
    # ูุนุงูุฌุงุช ุฑุณุงุฆู ููุญุฉ ุงูููุงุชูุญ
    application.add_handler(
        MessageHandler(filters.TEXT & filters.Regex(f"^{MESSAGES['keyboard_done']}$"), create_album)
    )
    application.add_handler(
        MessageHandler(filters.TEXT & filters.Regex(f"^{MESSAGES['keyboard_clear']}$"), reset_album)
    )
    # ุจุฏุก ุงูุจูุช ุจุงุณุชุฎุฏุงู long polling
    application.run_polling()

if __name__ == '__main__':
    main()

ุงุดุฑุญ ุงูููุฏ 
